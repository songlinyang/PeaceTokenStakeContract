# ShibMemeToken 代币合约操作指南

## 概述

ShibMemeToken 是一个基于 ERC20 标准的代币合约，集成了模块化的税务处理、交易限制和流动性管理功能。合约采用 UUPS 代理模式支持可升级功能，确保系统能够持续演进和优化。本指南详细说明如何部署、升级和使用该代币合约。

## 目录

1. [系统要求](#系统要求)
2. [可升级合约部署](#可升级合约部署)
3. [合约升级操作](#合约升级操作)
4. [代币交易](#代币交易)
5. [流动性管理](#流动性管理)
6. [配置管理](#配置管理)
7. [安全功能](#安全功能)
8. [应急操作](#应急操作)

## 系统要求

### 开发环境
- Node.js 16+
- Hardhat 开发框架
- Solidity 0.8.20+

### 依赖安装
```bash
npm install
```

## 可升级合约部署

### 1. 部署准备

#### 安装依赖包
```bash
# 安装 OpenZeppelin 可升级合约库
npm install @openzeppelin/contracts-upgradeable
npm install @openzeppelin/hardhat-upgrades
```

#### 配置 Hardhat
在 `hardhat.config.js` 中添加可升级插件：

```javascript
require('@openzeppelin/hardhat-upgrades');

module.exports = {
  solidity: "0.8.20",
  networks: {
    // 网络配置...
  }
};
```

### 2. UUPS 代理部署

使用 UUPS 代理模式部署可升级合约：

```javascript
const { ethers, upgrades } = require("hardhat");

async function main() {
  const [deployer] = await ethers.getSigners();
  
  console.log("正在使用 UUPS 代理部署可升级代币合约...");
  
  // 部署代理合约
  const ShibMemeToken = await ethers.getContractFactory("ShibMemeToken");
  const token = await upgrades.deployProxy(
    ShibMemeToken,
    [
      "ShibMeme Token",           // 代币名称
      "SHIBM",                    // 代币符号
      1000000000,                 // 总供应量（10亿）
      "0xTaxWalletAddress",       // 税务钱包地址
      "0xLiquidityWalletAddress", // 流动性钱包地址
      "0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D" // Uniswap V2 Router
    ],
    { 
      kind: 'uups',
      initializer: "initialize" // 如果使用初始化函数
    }
  );

  await token.waitForDeployment();
  console.log("代理合约已部署至:", await token.getAddress());
  console.log("逻辑合约地址:", await upgrades.erc1967.getImplementationAddress(await token.getAddress()));
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
```

### 3. 初始化处理器
部署后需要初始化各个处理器（注意：处理器也需要支持可升级）：

```javascript
// 初始化处理器
// 部署可升级的处理器合约
const TaxHandler = await ethers.getContractFactory("TaxHandler");
const taxHandler = await upgrades.deployProxy(
  TaxHandler,
  [
    tokenAddress,
    500,        // 买入税 5%
    500,        // 卖出税 5%
    100,        // 转账税 1%
    taxWalletAddress
  ],
  { kind: 'uups' }
);

const TradingRestric = await ethers.getContractFactory("TradingRestric");
const tradingRestric = await upgrades.deployProxy(
  TradingRestric,
  [
    1000000,    // 最大单笔交易量
    2000000,    // 最大钱包持有量
    500000,     // 每日卖出限额
    true        // 启用限制
  ],
  { kind: 'uups' }
);

const TreasuryHandler = await ethers.getContractFactory("TreasuryHandler");
const treasuryHandler = await upgrades.deployProxy(
  TreasuryHandler,
  [
    tokenAddress,
    liquidityWalletAddress,
    uniswapRouterAddress,
    200,        // 流动性费用 2%
    true,       // 启用自动流动性
    100000      // 最小流动性代币数量
  ],
  { kind: 'uups' }
);

// 设置处理器到管理器
await handlerManager.setHandlers(
  await taxHandler.getAddress(),
  await treasuryHandler.getAddress(),
  await tradingRestric.getAddress()
);
```

## 代币交易

### 1. 普通转账
```javascript
// 用户之间的代币转账
await token.transfer(recipientAddress, amount);

// 转账时会自动扣除转账税（如果启用）
// 转账税 = 转账金额 × 转账税率 / 10000
```

### 2. 买入交易
当用户从 Uniswap 交易对购买代币时：
- 自动应用买入税
- 验证交易限制
- 税费分配给税务钱包

```javascript
// 通过 Uniswap 购买代币
// 买入税 = 买入金额 × 买入税率 / 10000
```

### 3. 卖出交易
当用户向 Uniswap 交易对卖出代币时：
- 自动应用卖出税
- 验证每日卖出限制
- 部分税费用于自动添加流动性

```javascript
// 通过 Uniswap 卖出代币
// 卖出税 = 卖出金额 × 卖出税率 / 10000
// 其中部分税费用于流动性添加
```

## 流动性管理

### 1. 手动添加流动性
```javascript
// 仅合约所有者可调用
await token.addLiquidity(
  tokenAmount,  // 代币数量
  ethAmount     // ETH 数量（以 wei 为单位）
);
```

### 2. 手动移除流动性
```javascript
// 仅合约所有者可调用
await token.removeLiquidity(liquidityAmount);
```

### 3. 自动流动性添加
当启用自动流动性功能时：
- 卖出交易的部分税费自动用于添加流动性
- 达到最小代币数量阈值时触发
- 自动将代币兑换为 ETH 并添加流动性

## 配置管理

### 1. 税务配置
```javascript
// 设置税务参数
await token.setTaxConfig(
  buyTax,        // 买入税率（基于10000，如500表示5%）
  sellTax,       // 卖出税率
  transferTax,   // 转账税率
  taxWallet,     // 税务钱包地址
  taxEnabled     // 是否启用税费
);
```

### 2. 交易限制配置
```javascript
// 设置交易限制
await token.setTradeLimits(
  maxTxAmount,      // 最大单笔交易量
  maxWalletAmount,  // 最大钱包持有量
  dailySellLimit,   // 每日卖出限额
  limitsEnabled     // 是否启用限制
);
```

### 3. 流动性配置
```javascript
// 设置流动性参数
await token.setLiquidityConfig(
  liquidityFee,           // 流动性费用比例
  liquidityWallet,        // 流动性钱包地址
  autoLiquidityEnabled,   // 是否启用自动流动性
  minTokensForLiquidity   // 最小流动性代币数量
);
```

### 4. 地址管理
```javascript
// 设置费用排除地址
await token.excludeFromFee(account, true);

// 设置白名单地址（免除交易限制）
await token.setWhitelist(account, true);

// 设置黑名单地址（禁止交易）
await token.setBlacklist(account, true);

// 设置流动性提供者
await token.setLiquidityProvider(account, true);
```

## 安全功能

### 1. 交易限制
- **最大交易额限制**：防止大额交易操纵市场
- **钱包持有量限制**：防止单一地址过度集中代币
- **每日卖出限制**：防止恐慌性抛售
- **高频交易限制**：防止机器人攻击

### 2. 地址管理
- **白名单**：免除交易限制的地址
- **黑名单**：禁止交易的恶意地址
- **费用排除**：免征税费的地址
- **流动性提供者**：特殊权限的流动性管理地址

### 3. 处理器管理
```javascript
// 更新处理器管理器
await token.setHandlerManager(newManagerAddress);
```

## 应急操作

### 1. 紧急资金提取
```javascript
// 提取合约中的 ETH 和代币
await token.emergencyWithdraw();
```

### 2. 重置账户交易数据
```javascript
// 在 TradingRestric 合约中重置特定账户的交易数据
await tradingRestric.emergencyResetAccountData(account);
```

### 3. 处理器应急操作
各个处理器合约也提供了应急提取功能：
```javascript
// 提取意外发送的代币
await taxHandler.emergencyWithdrawToken(tokenAddress, amount);

// 提取意外发送的 ETH
await taxHandler.emergencyWithdrawEth(amount);
```

## 查询功能

### 1. 获取配置信息
```javascript
// 获取税务配置
const taxConfig = await token.getTaxConfig();

// 获取流动性配置
const liquidityConfig = await token.getLiquidityConfig();

// 获取交易限制配置
const tradeLimit = await token.getTradeLimit();
```

### 2. 获取账户交易数据
```javascript
// 获取账户的交易历史数据
const [lastSellTime, dailySellAmount, dailyTxCount, lastTxTime] = 
  await token.getAccountTradeData(account);
```

## 最佳实践

### 1. 部署前准备
- 充分测试所有功能
- 设置合理的税率和限制参数
- 准备应急钱包地址

### 2. 日常运营
- 定期监控交易数据
- 及时更新黑名单
- 监控流动性状况

### 3. 安全维护
- 妥善保管私钥
- 定期备份重要数据
- 建立应急响应流程

## 故障排除

### 常见问题

1. **交易失败**
   - 检查交易限制是否满足
   - 确认地址是否在黑名单中
   - 验证余额是否充足

2. **税费计算异常**
   - 检查税务配置是否正确
   - 确认地址是否在费用排除列表中

3. **流动性添加失败**
   - 确认代币和 ETH 余额充足
   - 检查滑点设置是否合理

## 技术支持

如需技术支持，请联系开发团队或查看合约源代码注释。

---

*本指南基于 ShibMemeToken 合约 v1.0.0 编写，具体操作请以实际部署的合约为准。*
